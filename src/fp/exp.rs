use super::*;

const EXP_TABLE_BITS : i32 = 10;
const EXP_TABLE_LEN  : i32 = 1 << EXP_TABLE_BITS;
const EXP_TABLE_MASK : i32 = EXP_TABLE_LEN - 1;
const EXP_TABLE_SHIFT : i32 = 16 - EXP_TABLE_BITS;

const FRAC_BITS : i32 = EXP_TABLE_SHIFT;
const FRAC_LEN  : i32 = 1 << FRAC_BITS;
const FRAC_MASK : i32 = FRAC_LEN - 1;

impl FP {
    pub fn exp(log : FP) -> FP {
        // println!("exp {:x} {:x}", log.int(), log.fraq());
        if log > FP_ZERO {
            (exp_from_table(log.frac()) + FP_ONE) << (log.int() as usize)
        } else {
            (exp_from_table(log.frac()) + FP_ONE) >> (-log.int() as usize)
        }
    }
}

/// return exp2(w/65536)
fn exp_from_table(w : FP) -> FP {
    let idx : usize = (((w.repr >> EXP_TABLE_SHIFT) & EXP_TABLE_MASK) as u16).into();
    let div : i32 = w.repr & FRAC_MASK; 

    /* get values from table */
    let bot : i32 = EXP_TABLE[idx ] as i32;
    let top : i32 = EXP_TABLE[idx + 1] as i32;

    /* interpolate and return */
    FP { repr : (bot * (FRAC_LEN - div) + top * div) >> FRAC_BITS }
}

const EXP_TABLE: [u16; (EXP_TABLE_LEN + 1) as usize] = [
        0,    44,    88,   133,   177,   222,   266,   311,   355,   400,   445,   489,   534,   579,   624,   668, 
      713,   758,   803,   848,   893,   938,   983,  1028,  1073,  1118,  1163,  1208,  1253,  1299,  1344,  1389, 
     1435,  1480,  1525,  1571,  1616,  1662,  1707,  1753,  1798,  1844,  1889,  1935,  1981,  2026,  2072,  2118, 
     2164,  2210,  2256,  2301,  2347,  2393,  2439,  2485,  2531,  2578,  2624,  2670,  2716,  2762,  2808,  2855, 
     2901,  2947,  2994,  3040,  3087,  3133,  3180,  3226,  3273,  3319,  3366,  3413,  3459,  3506,  3553,  3599, 
     3646,  3693,  3740,  3787,  3834,  3881,  3928,  3975,  4022,  4069,  4116,  4163,  4211,  4258,  4305,  4352, 
     4400,  4447,  4494,  4542,  4589,  4637,  4684,  4732,  4779,  4827,  4875,  4922,  4970,  5018,  5066,  5113, 
     5161,  5209,  5257,  5305,  5353,  5401,  5449,  5497,  5545,  5593,  5641,  5690,  5738,  5786,  5834,  5883, 
     5931,  5979,  6028,  6076,  6125,  6173,  6222,  6270,  6319,  6368,  6416,  6465,  6514,  6563,  6612,  6660, 
     6709,  6758,  6807,  6856,  6905,  6954,  7003,  7052,  7102,  7151,  7200,  7249,  7298,  7348,  7397,  7447, 
     7496,  7545,  7595,  7644,  7694,  7744,  7793,  7843,  7893,  7942,  7992,  8042,  8092,  8141,  8191,  8241, 
     8291,  8341,  8391,  8441,  8491,  8542,  8592,  8642,  8692,  8742,  8793,  8843,  8893,  8944,  8994,  9045, 
     9095,  9146,  9196,  9247,  9297,  9348,  9399,  9450,  9500,  9551,  9602,  9653,  9704,  9755,  9806,  9857, 
     9908,  9959, 10010, 10061, 10112, 10164, 10215, 10266, 10317, 10369, 10420, 10472, 10523, 10575, 10626, 10678, 
    10729, 10781, 10833, 10884, 10936, 10988, 11040, 11092, 11143, 11195, 11247, 11299, 11351, 11403, 11456, 11508, 
    11560, 11612, 11664, 11717, 11769, 11821, 11874, 11926, 11978, 12031, 12083, 12136, 12189, 12241, 12294, 12347, 
    12399, 12452, 12505, 12558, 12611, 12664, 12717, 12770, 12823, 12876, 12929, 12982, 13035, 13088, 13141, 13195, 
    13248, 13301, 13355, 13408, 13462, 13515, 13569, 13622, 13676, 13729, 13783, 13837, 13891, 13944, 13998, 14052, 
    14106, 14160, 14214, 14268, 14322, 14376, 14430, 14484, 14538, 14593, 14647, 14701, 14756, 14810, 14864, 14919, 
    14973, 15028, 15082, 15137, 15191, 15246, 15301, 15356, 15410, 15465, 15520, 15575, 15630, 15685, 15740, 15795, 
    15850, 15905, 15960, 16015, 16071, 16126, 16181, 16236, 16292, 16347, 16403, 16458, 16514, 16569, 16625, 16680, 
    16736, 16792, 16848, 16903, 16959, 17015, 17071, 17127, 17183, 17239, 17295, 17351, 17407, 17463, 17520, 17576, 
    17632, 17688, 17745, 17801, 17858, 17914, 17970, 18027, 18084, 18140, 18197, 18254, 18310, 18367, 18424, 18481, 
    18538, 18595, 18652, 18709, 18766, 18823, 18880, 18937, 18994, 19051, 19109, 19166, 19223, 19281, 19338, 19396, 
    19453, 19511, 19568, 19626, 19684, 19741, 19799, 19857, 19915, 19973, 20030, 20088, 20146, 20204, 20262, 20321, 
    20379, 20437, 20495, 20553, 20612, 20670, 20728, 20787, 20845, 20904, 20962, 21021, 21079, 21138, 21197, 21255, 
    21314, 21373, 21432, 21491, 21550, 21609, 21668, 21727, 21786, 21845, 21904, 21963, 22023, 22082, 22141, 22201, 
    22260, 22319, 22379, 22438, 22498, 22558, 22617, 22677, 22737, 22796, 22856, 22916, 22976, 23036, 23096, 23156, 
    23216, 23276, 23336, 23396, 23457, 23517, 23577, 23638, 23698, 23758, 23819, 23879, 23940, 24000, 24061, 24122, 
    24182, 24243, 24304, 24365, 24426, 24487, 24548, 24609, 24670, 24731, 24792, 24853, 24914, 24975, 25037, 25098, 
    25159, 25221, 25282, 25344, 25405, 25467, 25529, 25590, 25652, 25714, 25775, 25837, 25899, 25961, 26023, 26085, 
    26147, 26209, 26271, 26333, 26396, 26458, 26520, 26582, 26645, 26707, 26770, 26832, 26895, 26957, 27020, 27083, 
    27145, 27208, 27271, 27334, 27397, 27460, 27523, 27586, 27649, 27712, 27775, 27838, 27901, 27965, 28028, 28091, 
    28155, 28218, 28282, 28345, 28409, 28472, 28536, 28600, 28663, 28727, 28791, 28855, 28919, 28983, 29047, 29111, 
    29175, 29239, 29303, 29367, 29432, 29496, 29560, 29625, 29689, 29754, 29818, 29883, 29947, 30012, 30077, 30141, 
    30206, 30271, 30336, 30401, 30466, 30531, 30596, 30661, 30726, 30791, 30856, 30922, 30987, 31052, 31118, 31183, 
    31249, 31314, 31380, 31446, 31511, 31577, 31643, 31708, 31774, 31840, 31906, 31972, 32038, 32104, 32170, 32236, 
    32303, 32369, 32435, 32502, 32568, 32634, 32701, 32767, 32834, 32901, 32967, 33034, 33101, 33167, 33234, 33301, 
    33368, 33435, 33502, 33569, 33636, 33703, 33771, 33838, 33905, 33972, 34040, 34107, 34175, 34242, 34310, 34377, 
    34445, 34513, 34581, 34648, 34716, 34784, 34852, 34920, 34988, 35056, 35124, 35192, 35261, 35329, 35397, 35465, 
    35534, 35602, 35671, 35739, 35808, 35876, 35945, 36014, 36083, 36151, 36220, 36289, 36358, 36427, 36496, 36565, 
    36634, 36704, 36773, 36842, 36911, 36981, 37050, 37120, 37189, 37259, 37328, 37398, 37468, 37537, 37607, 37677, 
    37747, 37817, 37887, 37957, 38027, 38097, 38167, 38238, 38308, 38378, 38448, 38519, 38589, 38660, 38730, 38801, 
    38872, 38942, 39013, 39084, 39155, 39226, 39297, 39368, 39439, 39510, 39581, 39652, 39723, 39794, 39866, 39937, 
    40009, 40080, 40152, 40223, 40295, 40366, 40438, 40510, 40582, 40654, 40725, 40797, 40869, 40941, 41014, 41086, 
    41158, 41230, 41302, 41375, 41447, 41520, 41592, 41665, 41737, 41810, 41883, 41955, 42028, 42101, 42174, 42247, 
    42320, 42393, 42466, 42539, 42612, 42685, 42759, 42832, 42905, 42979, 43052, 43126, 43199, 43273, 43347, 43420, 
    43494, 43568, 43642, 43716, 43790, 43864, 43938, 44012, 44086, 44160, 44235, 44309, 44383, 44458, 44532, 44607, 
    44681, 44756, 44831, 44906, 44980, 45055, 45130, 45205, 45280, 45355, 45430, 45505, 45580, 45656, 45731, 45806, 
    45882, 45957, 46033, 46108, 46184, 46259, 46335, 46411, 46487, 46563, 46638, 46714, 46790, 46866, 46943, 47019, 
    47095, 47171, 47248, 47324, 47400, 47477, 47553, 47630, 47707, 47783, 47860, 47937, 48014, 48090, 48167, 48244, 
    48321, 48399, 48476, 48553, 48630, 48707, 48785, 48862, 48940, 49017, 49095, 49172, 49250, 49328, 49406, 49483, 
    49561, 49639, 49717, 49795, 49873, 49951, 50030, 50108, 50186, 50265, 50343, 50421, 50500, 50579, 50657, 50736, 
    50815, 50893, 50972, 51051, 51130, 51209, 51288, 51367, 51446, 51526, 51605, 51684, 51764, 51843, 51922, 52002, 
    52082, 52161, 52241, 52321, 52400, 52480, 52560, 52640, 52720, 52800, 52880, 52961, 53041, 53121, 53201, 53282, 
    53362, 53443, 53523, 53604, 53685, 53765, 53846, 53927, 54008, 54089, 54170, 54251, 54332, 54413, 54494, 54576, 
    54657, 54738, 54820, 54901, 54983, 55065, 55146, 55228, 55310, 55392, 55473, 55555, 55637, 55719, 55801, 55884, 
    55966, 56048, 56130, 56213, 56295, 56378, 56460, 56543, 56626, 56708, 56791, 56874, 56957, 57040, 57123, 57206, 
    57289, 57372, 57455, 57539, 57622, 57705, 57789, 57872, 57956, 58040, 58123, 58207, 58291, 58375, 58458, 58542, 
    58626, 58711, 58795, 58879, 58963, 59047, 59132, 59216, 59301, 59385, 59470, 59554, 59639, 59724, 59809, 59894, 
    59978, 60063, 60149, 60234, 60319, 60404, 60489, 60575, 60660, 60745, 60831, 60917, 61002, 61088, 61174, 61259, 
    61345, 61431, 61517, 61603, 61689, 61775, 61862, 61948, 62034, 62121, 62207, 62294, 62380, 62467, 62553, 62640, 
    62727, 62814, 62901, 62988, 63075, 63162, 63249, 63336, 63423, 63511, 63598, 63686, 63773, 63861, 63948, 64036, 
    64124, 64211, 64299, 64387, 64475, 64563, 64651, 64739, 64828, 64916, 65004, 65093, 65181, 65270, 65358, 65447, 
    65535 ];
